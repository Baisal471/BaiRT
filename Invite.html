<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>X-–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<style>
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100vh; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #app {
    display: flex;
    width: 90vw;
    height: 90vh;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    border-radius: 10px;
    overflow: hidden;
    background: white;
  }

  /* –°–µ–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
  #loginScreen {
    width: 400px;
    padding: 30px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  #loginScreen h2 {
    margin-bottom: 20px;
    text-align: center;
  }
  #loginScreen input[type="text"],
  #loginScreen input[type="password"] {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1.5px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
  }
  #loginScreen button {
    padding: 12px;
    background: #1DA1F2;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #loginScreen button:hover {
    background: #0d8ddb;
  }
  #loginScreen .switchMode {
    margin-top: 15px;
    text-align: center;
    color: #555;
    cursor: pointer;
    user-select: none;
  }
  #loginScreen .error {
    color: red;
    margin-bottom: 15px;
    font-size: 14px;
  }

  /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
  #mainApp {
    display: flex;
    width: 100%;
    height: 100%;
  }

  /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ */
  #usersList {
    width: 280px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  #usersList header {
    padding: 15px;
    font-weight: 700;
    font-size: 18px;
    border-bottom: 1px solid #ddd;
    background: #f9fafb;
  }
  #usersList .user {
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  #usersList .user:hover {
    background: #e8f5fe;
  }
  #usersList .user img.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
  }
  #usersList .user .user-info {
    flex-grow: 1;
  }
  #usersList .user .user-info .username {
    font-weight: 700;
    font-size: 15px;
    color: #222;
  }
  #usersList .user .user-info .name {
    font-size: 13px;
    color: #666;
  }
  #usersList .user button.subscribe-btn {
    background: #1DA1F2;
    border: none;
    border-radius: 15px;
    color: white;
    padding: 5px 12px;
    font-size: 13px;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
  }
  #usersList .user button.subscribe-btn.subscribed {
    background: #657786;
  }

  /* –°–µ—Ä–µ–¥–∏–Ω–∞ ‚Äî –ª–µ–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π */
  #feed {
    flex-grow: 1;
    overflow-y: auto;
    background: white;
    display: flex;
    flex-direction: column;
  }
  #feed header {
    padding: 15px;
    font-weight: 700;
    font-size: 20px;
    border-bottom: 1px solid #ddd;
    background: #f9fafb;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  #feed .post-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
  }
  #feed .post {
    border-bottom: 1px solid #eee;
    padding: 12px 0;
  }
  #feed .post:last-child {
    border-bottom: none;
  }
  #feed .post .post-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  #feed .post .post-header img.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
  }
  #feed .post .post-header .username {
    font-weight: 700;
    font-size: 14px;
    color: #1DA1F2;
    cursor: pointer;
  }
  #feed .post .post-content {
    font-size: 15px;
    color: #222;
    white-space: pre-wrap;
  }

  /* –ü—Ä–∞–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å */
  #profile {
    width: 320px;
    border-left: 1px solid #ddd;
    background: #f9fafb;
    padding: 15px;
    display: flex;
    flex-direction: column;
  }
  #profile header {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 15px;
  }
  #profile .avatar-upload {
    align-self: center;
    margin-bottom: 15px;
    position: relative;
  }
  #profile .avatar-upload img.avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #1DA1F2;
  }
  #profile input[type="file"] {
    display: none;
  }
  #profile label.upload-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    background: #1DA1F2;
    color: white;
    padding: 5px 10px;
    font-size: 13px;
    border-radius: 20px;
    cursor: pointer;
  }
  #profile .edit-field {
    margin-bottom: 10px;
  }
  #profile .edit-field label {
    display: block;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 4px;
    color: #555;
  }
  #profile .edit-field input[type="text"] {
    width: 100%;
    padding: 8px;
    border: 1.5px solid #ccc;
    border-radius: 5px;
    font-size: 15px;
  }
  #profile button.save-btn {
    margin-top: auto;
    background: #1DA1F2;
    color: white;
    border: none;
    padding: 12px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
  }
  #profile button.save-btn:hover {
    background: #0d8ddb;
  }

  /* –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é */
  #newPostForm {
    border-top: 1px solid #ddd;
    padding: 15px;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
  }
  #newPostForm textarea {
    width: 100%;
    resize: vertical;
    min-height: 60px;
    padding: 10px;
    font-size: 15px;
    border-radius: 8px;
    border: 1.5px solid #ccc;
    margin-bottom: 10px;
  }
  #newPostForm button {
    align-self: flex-end;
    background: #1DA1F2;
    border: none;
    color: white;
    padding: 10px 16px;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    font-size: 15px;
  }
  #newPostForm button:disabled {
    background: #a7d4f9;
    cursor: default;
  }

  /* –°–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è feed –∏ post-list */
  #feed .post-list::-webkit-scrollbar,
  #feed::-webkit-scrollbar {
    width: 7px;
  }
  #feed .post-list::-webkit-scrollbar-thumb,
  #feed::-webkit-scrollbar-thumb {
    background: #1DA1F2;
    border-radius: 10px;
  }
</style>
</head>
<body>
<div id="app">
  <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–ª–æ–≥–∏–Ω–∞ -->
  <div id="loginScreen">
    <h2 id="loginTitle">–í—Ö–æ–¥ –≤ X-–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
    <div class="error" id="loginError"></div>
    <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)" autocomplete="off" />
    <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <div class="switchMode" id="switchToRegister">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="mainApp" style="display:none;">
    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–ª–µ–≤–∞ -->
    <div id="usersList">
      <header>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</header>
      <div id="usersContainer"></div>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π -->
    <div id="feed">
      <header>–õ–µ–Ω—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</header>
      <div id="postList" class="post-list"></div>
      <form id="newPostForm">
        <textarea id="newPostText" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" maxlength="280"></textarea>
        <button type="submit" disabled>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </form>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å —Å–ø—Ä–∞–≤–∞ -->
    <div id="profile">
      <header>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</header>
      <div class="avatar-upload">
        <img src="" alt="–ê–≤–∞—Ç–∞—Ä" id="profileAvatar" class="avatar" />
        <label for="avatarInput" class="upload-btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">üì∑</label>
        <input type="file" id="avatarInput" accept="image/*" />
      </div>
      <div class="edit-field">
        <label for="profileUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" id="profileUsername" disabled />
      </div>
      <div class="edit-field">
        <label for="profileName">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
        <input type="text" id="profileName" />
      </div>
      <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>
  </div>
</div>

<script>
  // --- –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

  // users = [{username, password, name, avatarDataUrl, subscriptions: []}]
  // posts = [{id, username, content, timestamp}]
  // currentUser = username

  // –ö–ª—é—á–∏ localStorage
  const LS_USERS = "xmessenger_users";
  const LS_POSTS = "xmessenger_posts";
  const LS_CURRENT_USER = "xmessenger_currentUser";

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –∏–ª–∏ –ø—É—Å—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  let users = JSON.parse(localStorage.getItem(LS_USERS) || "[]");
  let posts = JSON.parse(localStorage.getItem(LS_POSTS) || "[]");
  let currentUser = localStorage.getItem(LS_CURRENT_USER);

  // –≠–ª–µ–º–µ–Ω—Ç—ã
  const loginScreen = document.getElementById("loginScreen");
  const mainApp = document.getElementById("mainApp");
  const loginTitle = document.getElementById("loginTitle");
  const loginError = document.getElementById("loginError");
  const loginUsernameInput = document.getElementById("loginUsername");
  const loginPasswordInput = document.getElementById("loginPassword");
  const loginBtn = document.getElementById("loginBtn");
  const switchToRegister = document.getElementById("switchToRegister");

  const usersContainer = document.getElementById("usersContainer");
  const postList = document.getElementById("postList");
  const newPostForm = document.getElementById("newPostForm");
  const newPostText = document.getElementById("newPostText");
  const newPostBtn = newPostForm.querySelector("button");

  const profileAvatar = document.getElementById("profileAvatar");
  const avatarInput = document.getElementById("avatarInput");
  const profileUsernameInput = document.getElementById("profileUsername");
  const profileNameInput = document.getElementById("profileName");
  const saveProfileBtn = document.getElementById("saveProfileBtn");

  // –†–µ–∂–∏–º: login –∏–ª–∏ register
  let mode = "login";

  // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è localStorage ---
  function saveUsers() {
    localStorage.setItem(LS_USERS, JSON.stringify(users));
  }
  function savePosts() {
    localStorage.setItem(LS_POSTS, JSON.stringify(posts));
  }
  function saveCurrentUser() {
    localStorage.setItem(LS_CURRENT_USER, currentUser);
  }

  // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username
  function findUser(username) {
    return users.find(u => u.username === username);
  }

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å username (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
  function validUsername(name) {
    return /^[a-zA-Z0-9_]+$/.test(name);
  }

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤–∞—Ç–∞—Ä-–∑–∞–≥–ª—É—à–∫—É (—Ü–≤–µ—Ç–Ω–æ–π –∫—Ä—É–≥ —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π)
  function defaultAvatar(username) {
    const colors = [
      "#1DA1F2","#17BF63","#E0245E","#FFAD1F","#794BC4",
      "#F45D22","#E81C4F","#00B8E8","#FF6F61","#00A67E"
    ];
    const char = username.charAt(0).toUpperCase();
    const colorIndex = username.charCodeAt(0) % colors.length;
    const bg = colors[colorIndex];
    // –°–æ–∑–¥–∞—ë–º canvas, —Ä–∏—Å—É–µ–º –±—É–∫–≤—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º dataURL
    const canvas = document.createElement("canvas");
    canvas.width = 100; canvas.height = 100;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,100,100);
    ctx.font = "bold 60px Arial";
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(char, 50, 58);
    return canvas.toDataURL();
  }

  // –†–µ–Ω–¥–µ—Ä —ç–∫—Ä–∞–Ω–∞ –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  function renderLogin() {
    loginScreen.style.display = "flex";
    mainApp.style.display = "none";
    loginError.textContent = "";
    loginUsernameInput.value = "";
    loginPasswordInput.value = "";
    if (mode === "login") {
      loginTitle.textContent = "–í—Ö–æ–¥ –≤ X-–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä";
      loginBtn.textContent = "–í–æ–π—Ç–∏";
      switchToRegister.textContent = "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
    } else {
      loginTitle.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ X-–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä";
      loginBtn.textContent = "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
      switchToRegister.textContent = "–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏";
    }
  }

  // –†–µ–Ω–¥–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  function renderApp() {
    loginScreen.style.display = "none";
    mainApp.style.display = "flex";
    renderUsersList();
    renderFeed();
    renderProfile();
    newPostText.value = "";
    newPostBtn.disabled = true;
  }

  // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî **–≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**
  function renderUsersList() {
    usersContainer.innerHTML = "";
    users.forEach(user => {
      const userDiv = document.createElement("div");
      userDiv.className = "user";

      const avatarImg = document.createElement("img");
      avatarImg.className = "avatar";
      avatarImg.src = user.avatarDataUrl || defaultAvatar(user.username);
      avatarImg.alt = user.username;
      userDiv.appendChild(avatarImg);

      const infoDiv = document.createElement("div");
      infoDiv.className = "user-info";

      const unameDiv = document.createElement("div");
      unameDiv.className = "username";
      unameDiv.textContent = "@" + user.username;

      const nameDiv = document.createElement("div");
      nameDiv.className = "name";
      nameDiv.textContent = user.name || "–ë–µ–∑ –∏–º–µ–Ω–∏";

      infoDiv.appendChild(unameDiv);
      infoDiv.appendChild(nameDiv);
      userDiv.appendChild(infoDiv);

      if(user.username !== currentUser){
        const btn = document.createElement("button");
        btn.className = "subscribe-btn";
        const currentUserObj = findUser(currentUser);
        const isSubscribed = currentUserObj.subscriptions && currentUserObj.subscriptions.includes(user.username);
        if(isSubscribed){
          btn.textContent = "–û—Ç–ø–∏—Å–∞—Ç—å—Å—è";
          btn.classList.add("subscribed");
        } else {
          btn.textContent = "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
        }
        btn.onclick = () => {
          toggleSubscription(user.username);
        };
        userDiv.appendChild(btn);
      }

      usersContainer.appendChild(userDiv);
    });
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –¥—Ä—É–≥–æ–≥–æ
  function toggleSubscription(usernameToToggle) {
    const currentUserObj = findUser(currentUser);
    if(!currentUserObj.subscriptions) currentUserObj.subscriptions = [];
    if(currentUserObj.subscriptions.includes(usernameToToggle)){
      // –û—Ç–ø–∏—Å–∞—Ç—å—Å—è
      currentUserObj.subscriptions = currentUserObj.subscriptions.filter(u => u !== usernameToToggle);
    } else {
      // –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
      currentUserObj.subscriptions.push(usernameToToggle);
    }
    saveUsers();
    renderUsersList();
    renderFeed();
  }

  // –†–µ–Ω–¥–µ—Ä –ª–µ–Ω—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–π ‚Äî **–≤—Å–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞**
  function renderFeed() {
    postList.innerHTML = "";
    if(!currentUser) return;

    // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã
    let feedPosts = posts.slice();

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    feedPosts.sort((a,b) => b.timestamp - a.timestamp);

    feedPosts.forEach(post => {
      const postUser = findUser(post.username);

      const postDiv = document.createElement("div");
      postDiv.className = "post";

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∞–≤–∞—Ç–∞—Ä–æ–º –∏ –Ω–∏–∫–æ–º
      const headerDiv = document.createElement("div");
      headerDiv.className = "post-header";

      const avatarImg = document.createElement("img");
      avatarImg.className = "avatar";
      avatarImg.src = (postUser && postUser.avatarDataUrl) || defaultAvatar(post.username);
      avatarImg.alt = post.username;
      headerDiv.appendChild(avatarImg);

      const usernameSpan = document.createElement("span");
      usernameSpan.className = "username";
      usernameSpan.textContent = "@" + post.username;
      headerDiv.appendChild(usernameSpan);

      postDiv.appendChild(headerDiv);

      // –¢–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
      const contentDiv = document.createElement("div");
      contentDiv.className = "post-content";
      contentDiv.textContent = post.content;
      postDiv.appendChild(contentDiv);

      postList.appendChild(postDiv);
    });
  }

  // –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  function renderProfile() {
    const user = findUser(currentUser);
    if(!user) return;
    profileUsernameInput.value = user.username;
    profileNameInput.value = user.name || "";
    profileAvatar.src = user.avatarDataUrl || defaultAvatar(user.username);
  }

  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  function resetLoginForm() {
    loginUsernameInput.value = "";
    loginPasswordInput.value = "";
    loginError.textContent = "";
  }

  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É login –∏ register
  switchToRegister.addEventListener("click", () => {
    mode = (mode === "login") ? "register" : "login";
    resetLoginForm();
    renderLogin();
  });

  // –õ–æ–≥–∏–Ω / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  loginBtn.addEventListener("click", () => {
    const username = loginUsernameInput.value.trim();
    const password = loginPasswordInput.value.trim();

    if(!username || !password){
      loginError.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
      return;
    }
    if(!validUsername(username)){
      loginError.textContent = "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è";
      return;
    }

    if(mode === "login"){
      // –í—Ö–æ–¥
      const user = findUser(username);
      if(!user || user.password !== password){
        loginError.textContent = "–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
        return;
      }
      currentUser = username;
      saveCurrentUser();
      renderApp();
    } else {
      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
      if(findUser(username)){
        loginError.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
        return;
      }
      // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      users.push({
        username,
        password,
        name: "",
        avatarDataUrl: "",
        subscriptions: []
      });
      saveUsers();
      currentUser = username;
      saveCurrentUser();
      renderApp();
    }
  });

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –µ—Å–ª–∏ —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
  if(currentUser && findUser(currentUser)){
    renderApp();
  } else {
    renderLogin();
  }

  // –í–≤–æ–¥ –≤ –Ω–æ–≤—ã–π –ø–æ—Å—Ç ‚Äî –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
  newPostText.addEventListener("input", () => {
    newPostBtn.disabled = newPostText.value.trim().length === 0;
  });

  // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é
  newPostForm.addEventListener("submit", e => {
    e.preventDefault();
    const content = newPostText.value.trim();
    if(!content) return;

    const newPost = {
      id: Date.now() + Math.random(),
      username: currentUser,
      content,
      timestamp: Date.now()
    };
    posts.push(newPost);
    savePosts();
    newPostText.value = "";
    newPostBtn.disabled = true;
    renderFeed();
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
  avatarInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const user = findUser(currentUser);
      if(user){
        user.avatarDataUrl = reader.result;
        saveUsers();
        renderProfile();
        renderUsersList();
        renderFeed();
      }
    };
    reader.readAsDataURL(file);
  });

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è)
  saveProfileBtn.addEventListener("click", () => {
    const user = findUser(currentUser);
    if(user){
      user.name = profileNameInput.value.trim();
      saveUsers();
      renderUsersList();
    }
  });

</script>
</body>
</html>
